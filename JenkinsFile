pipeline{
	agent any
    tools {
      maven 'MVN_HOME'
      jdk "JDK11"
    }
	
	
    environment {
        DOCKER_HUB_CREDENTIALS = credentials('dckr_pat_JGv13MSwXbSrvIr_kd52HH1nNAk')
    }

    stages{
       stage('Maven Build') {
         steps {
			// print system information
		   sh "uname -a";
		   
		   // mvn build
		   echo 'start: mvn clean package'
           sh "mvn clean package"
		   
         }
		 
		 post {
		   always {
				echo "end: mvn clean package"
		   }
		   success {
				junit '**/target/surefire-reports/TEST-*.xml'
		   }
		 }
       }
       
      stage('Docker Build'){
            steps{
				sh "docker build -t jonathanyoungefreilearning/tomcat_example .";
				// sh "sudo docker build -t jonathanyoungefreilearning/tomcat_example .";
            }
        }
      stage('DockerHub Push') {
            steps {
                withCredentials([string(credentialsId: 'docker-hub-pat', variable: 'DOCKER_HUB_ACCESS_TOKEN')]) {
                    sh "echo 'Logging in to Docker Hub'"
                    sh "docker login -u jonathanyoungefreilearning --password-stdin <<< \$DOCKER_HUB_ACCESS_TOKEN"
                    sh "docker push jonathanyoungefreilearning/tomcat_example:latest"
                }
            }
        }
  
      stage('Docker Deploy'){
            steps{
				sh "ansible-playbook client.yaml"
            }
        }        
    }
    
}
