pipeline{
	agent any
    tools {
      maven 'MVN_HOME'
      jdk "JDK11"
    }
	
	
    environment {
        DOCKER_HUB_CREDENTIALS = credentials('docker-hub-creds')
    }

    stages{
       stage('Maven Build') {
         steps {
			// print system information
		   sh "uname -a";
		   
		   // mvn build
		   echo 'start: mvn clean package'
           sh "mvn clean package"
		   
         }
		 
		 post {
		   always {
				echo "end: mvn clean package"
		   }
		   success {
				junit '**/target/surefire-reports/TEST-*.xml'
		   }
		 }
       }
       
        stage('Docker Build'){
            steps{
		sh "docker build -t jonathanefreilearning/tomcat_example .";
		// sh "sudo docker build -t jonathanefreilearning/tomcat_example .";
            }
        }
	stage('DockerHub Push') {
	    steps {
	        script {
			withCredentials([sshUserPrivateKey(credentialsId: 'your-ssh-credentials-id', keyFileVariable: 'SSH_KEY')]) {
                	// Run Ansible ping command using the SSH key
                	sh "ansible -m ping -u eastih -i '${ansible_host},' --private-key=${SSH_KEY} ${ansible_extra_args}"
	            	//docker.withRegistry('', 'docker-hub-creds') {
	                //sh "docker push jonathanefreilearning/tomcat_example:latest"
		            }
		        }
		    }
		}
	    }

      stage('Docker Deploy'){
            steps{
		script{
			sh "ansible-playbook deploy-docker.yml"
		}	
            }
        }        
    }
    
}
